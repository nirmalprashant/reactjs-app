### 3 Tier Appp

## Part 2

eksctl create cluster --name quizapp-eks-cluster1 --region ap-south-1 --node-type t2.large --nodes-min 2 --nodes-max 4

aws eks update-kubeconfig --region ap-south-1 --name quizapp-eks-cluster1

kubectl get nodes

curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.5.4/docs/install/iam_policy.json

aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam_policy.json

eksctl utils associate-iam-oidc-provider --region=ap-south-1 --cluster=quizapp-eks-cluster1 --approve

eksctl create iamserviceaccount --cluster=quizapp-eks-cluster1 --namespace=kube-system --name=aws-load-balancer-controller --role-name AmazonEKSLoadBalancerControllerRole --attach-policy-arn=arn:aws:iam::637423651240:policy/AWSLoadBalancerControllerIAMPolicy --approve --region=ap-south-1

##If above cmd gives error  failed to create iamserviceaccount(s)

eksctl create iamserviceaccount \
  --cluster=quizapp-eks-cluster1 \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --attach-policy-arn=arn:aws:iam::637423651240:policy/AWSLoadBalancerControllerIAMPolicy \
  --approve \
  --region=ap-south-1 \
  --role-name AmazonEKSLoadBalancerControllerRole \
  --override-existing-serviceaccounts

sudo snap install helm --classic
helm repo add eks https://aws.github.io/eks-charts
helm repo update eks
helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=quizapp-eks-cluster1 --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller

kubectl get deployment -n kube-system aws-load-balancer-controller

##if above deployment are not ready within seconds

helm status aws-load-balancer-controller -n kube-system

kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller

##error:No resources found in kube-system namespace.

kubectl get serviceaccount aws-load-balancer-controller -n kube-system

##Error from server (NotFound): serviceaccounts "aws-load-balancer-controller" not found

kubectl create serviceaccount aws-load-balancer-controller -n kube-system

kubectl annotate serviceaccount aws-load-balancer-controller \
  -n kube-system \
  eks.amazonaws.com/role-arn=arn:aws:iam::637423651240:role/AmazonEKSLoadBalancerControllerRole

helm uninstall aws-load-balancer-controller -n kube-system

helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \
  --set clusterName=quizapp-eks-cluster1 \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller

kubectl create ns quiz

kubectl create ns argocd

kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.4.7/manifests/install.yaml

kubectl get pods -n argocd

kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

sudo apt install jq -y

export ARGOCD_SERVER=`kubectl get svc argocd-server -n argocd -o json | jq --raw-output '.status.loadBalancer.ingress[0].hostname'`
export ARGO_PWD=`kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d`
echo $ARGO_PWD

##use the LoadBalancer DNS ip for argocd

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

helm install prometheus prometheus-community/kube-prometheus-stack -n monitoring --create-namespace

helm install grafana grafana/grafana -n monitoring --create-namespace

kubectl edit svc prometheus-kube-prometheus-prometheus -n monitoring

## change the clusterip to LoadBalancer

kubectl edit svc grafana -n monitoring

## change the clusterip to LoadBalancer

kubectl get svc -n monitoring

##use the LoadBalancer DNS ip for prometheus port 9090

kubectl get secret --namespace monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo

##use the LoadBalancer DNS ip for grafana

##after login click data source > prometheus > add DNS ip for prometheus port 9090 > save & test

##in grafana home > dashboard > new+ > import > 6417 , 15757 , 15760 , 15759 , 15758 , 15761 

## go to argocd > new app

##copy LoadBalancer DNS name k8s-quiz-mainlb

##go to route53 > hosted zones > sub domain quizapp

kubectl get pods -n quiz

kubectl logs backend-85d7b6fdf-j4b75 -n quiz

kubectl logs frontend-66bf887fcf-c5s2w -n quiz

kubectl logs mongo-57985bc6d9-b2hjd -n quiz

eksctl delete cluster --name=quizapp-eks-cluster1 --region=ap-south-1

##helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
##helm repo update